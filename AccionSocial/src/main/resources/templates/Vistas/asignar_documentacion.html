<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar Documentación - Acción Social</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .navbar-brand { font-size: 1.4rem; font-weight: 600; }
        .nav-link { transition: all 0.3s ease; border-radius: 5px; margin: 0 2px; }
        .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateY(-1px); }
        .dropdown-menu { border: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .dropdown-item:hover { background-color: #f8f9fa; padding-left: 1.5rem; }
        .card { border: none; border-radius: 10px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important; }
        .btn { border-radius: 6px; transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .table-hover tbody tr { transition: background-color 0.2s ease; }
        .table-hover tbody tr:hover { background-color: rgba(13, 110, 253, 0.05); }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav th:replace="~{Vistas/menu :: menu}"></nav>
    
    <div class="container mt-4">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h4 class="m-0">
                    <i class="bi bi-file-earmark-plus me-2"></i>Asignar Documentación a Legajo
                </h4>
            </div>
            <div class="card-body">
                <!-- Información del Legajo -->
                <div class="alert alert-info">
                    <i class="bi bi-person-fill me-2"></i>
                    <strong>Legajo:</strong> <span th:text="${legajo.nombre + ' ' + legajo.apellido}"></span> - 
                    <strong>DNI:</strong> <span th:text="${legajo.dni}"></span>
                </div>

                <!-- Mensajes -->
                <div th:if="${mensaje != null or param.mensaje != null}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    <span th:text="${mensaje != null ? mensaje : param.mensaje[0]}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${error != null or param.error != null}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <span th:text="${error != null ? error : param.error[0]}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Formulario de asignación -->
                <div th:if="${documentacionesDisponibles != null and !documentacionesDisponibles.isEmpty()}">
                    <form th:action="@{/asignardocumentacion/{id}(id=${legajo.id})}" method="post">
                        <div class="mb-4">
                            <label for="documentacionId" class="form-label">
                                <strong><i class="bi bi-file-earmark-text me-2"></i>Seleccionar Documentación:</strong>
                            </label>
                            <select class="form-select form-select-lg" id="documentacionId" name="documentacionId" required>
                                <option value="">-- Seleccione una documentación --</option>
                                <option th:each="doc : ${documentacionesDisponibles}" 
                                        th:value="${doc.id}"
                                        th:text="${doc.tipoDocumento + ' - Nº ' + doc.numero + ' (Ingreso: ' + #temporals.format(doc.fechaIngreso, 'dd/MM/yyyy') + ')'}">
                                </option>
                            </select>
                        </div>

                        <!-- Información de la documentación seleccionada -->
                        <div id="infoDocumentacion" class="card mb-4" style="display: none;">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Información de la Documentación</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <tbody id="documentacionInfo">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario de asignación -->
                        <div id="formularioAsignacion" style="display: none;">
                            <hr class="my-4">
                            <h5 class="mb-3"><i class="bi bi-file-earmark-check me-2"></i>Formulario de Asignación</h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="estado" class="form-label">
                                        <strong>Estado de la Documentación:</strong>
                                    </label>
                                    <select class="form-select" id="estado" name="estado" required>
                                        <option value="Pendiente" selected>Pendiente</option>
                                        <option value="Entregado">Entregado</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Seleccione el estado actual de la documentación
                                    </small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="fechaAsignacion" class="form-label">
                                        <strong>Fecha de Asignación:</strong>
                                    </label>
                                    <input type="date" class="form-control" id="fechaAsignacion" name="fechaAsignacion" 
                                           th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}" required>
                                    <small class="form-text text-muted">
                                        Fecha en que se asigna la documentación al legajo
                                    </small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="observaciones" class="form-label">
                                    <strong>Observaciones (Opcional):</strong>
                                </label>
                                <textarea class="form-control" id="observaciones" name="observaciones" rows="3" 
                                          placeholder="Ingrese observaciones adicionales sobre la asignación..."></textarea>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" id="btnAsignar" class="btn btn-info btn-lg me-2" disabled>
                                <i class="bi bi-check-circle me-2"></i>Asignar Documentación
                            </button>
                            <a th:href="@{/detallelegajo/{id}(id=${legajo.id})}" class="btn btn-secondary btn-lg">
                                <i class="bi bi-x-circle me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>

                <div th:if="${documentacionesDisponibles == null or documentacionesDisponibles.isEmpty()}" class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-triangle display-4 d-block mb-3"></i>
                    <p class="lead">No hay documentaciones disponibles para asignar.</p>
                    <p class="text-muted">Primero debes crear documentaciones en el sistema.</p>
                    <div class="mt-3">
                        <a th:href="@{/formulariodocumentacion}" class="btn btn-info me-2">
                            <i class="bi bi-plus-circle me-2"></i>Crear Nueva Documentación
                        </a>
                        <a th:href="@{/detallelegajo/{id}(id=${legajo.id})}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Volver al Legajo
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer th:replace="~{Vistas/menu :: footer}"></footer>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const documentaciones = /*[[${documentacionesDisponibles}]]*/ [];
        
        document.getElementById('documentacionId').addEventListener('change', function() {
            const select = document.getElementById('documentacionId');
            const documentacionId = select.value;
            const infoDiv = document.getElementById('infoDocumentacion');
            const infoBody = document.getElementById('documentacionInfo');
            
            if (documentacionId) {
                const doc = documentaciones.find(d => {
                    const dId = d.id ? (typeof d.id === 'string' ? parseInt(d.id) : d.id) : null;
                    const selId = typeof documentacionId === 'string' ? parseInt(documentacionId) : documentacionId;
                    return dId === selId;
                });
                
                if (doc) {
                    const fecha = doc.fechaIngreso ? new Date(doc.fechaIngreso).toLocaleDateString('es-AR') : 'N/A';
                    const estado = doc.estado || 'Sin estado';
                    
                    infoBody.innerHTML = `
                        <tr>
                            <td class="fw-bold" style="width: 30%;">Tipo de Documento:</td>
                            <td><span class="badge bg-primary">${doc.tipoDocumento || 'N/A'}</span></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Número:</td>
                            <td><strong>${doc.numero || 'N/A'}</strong></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Fecha de Ingreso:</td>
                            <td>${fecha}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Estado Actual:</td>
                            <td>
                                <span class="badge ${estado === 'Pendiente' ? 'bg-warning' : estado === 'Entregado' ? 'bg-success' : 'bg-secondary'}">${estado}</span>
                            </td>
                        </tr>
                    `;
                    infoDiv.style.display = 'block';
                    
                    // Mostrar formulario de asignación
                    document.getElementById('formularioAsignacion').style.display = 'block';
                    document.getElementById('btnAsignar').disabled = false;
                } else {
                    infoDiv.style.display = 'none';
                    document.getElementById('formularioAsignacion').style.display = 'none';
                    document.getElementById('btnAsignar').disabled = true;
                }
            } else {
                infoDiv.style.display = 'none';
                document.getElementById('formularioAsignacion').style.display = 'none';
                document.getElementById('btnAsignar').disabled = true;
            }
        });
        /*]]>*/
    </script>
</body>
</html>

